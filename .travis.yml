language: java
cache:
  apt: true
  directories:
  - "$HOME/octave"
env:
  global:
  - OCTAVE=octave
  - secure: AuaFi6wbz58JxJauG+EYGyYTjoh5aK9I6RiECfC+KJ2E7rmnf1wi9gDEArylSs8Eg6sKGekYiE11RB7eTjQwePZcYnKDj5XD2ROsNZ0eDlcqMB67DjjNX8ozn9mnht3ba2JqbCXUGz1TH3CrZurjE0rnR0VksDygLZOdvSlv9OqL1Jvf8anV75fkRIjPB1wLvGsxkQHh2OivGyNQhAH9rUeZawHZTqRQUsO92z+mO5NQDay5r43ZmhKdC600oUhTVlJjgm9NRnyxz+r4rLp7rLlrAyHlUVYvb5zgWbQbjdfeZ08+yEqgleULs9zOzMq9AJm7ba6mUXz065mctwmT4uC3aIQjKcmeaE7TZTVCkiVhc3opIUatmBgActPzTJ9NPXt48/uxZF42s1cTRaDZNm9iIZxQK9Np+CelB7b5MSsIZ8UMpaBU+H8IIr7XGoa0ReQ2vYDnzA6XIwlxiVL8nvO//LOA7vmRe6xwFrgnWtC/B/CcqWw+Hdw3H0lEZW9ikwfNAWmUkjh5zR6MI2PQ7oTxp2SyFjJhDLEMltO0BIo0pAEW1HWUGtvkU9n5RGwc9a2TFzi8eNadDw3VQqcsPzx6fl1yEMYLviG4At0dZsO0PWaOzGy+J51UZDwKHuolIMYsJEBkAQsZmCLiJR+TYvKge2fii5ZXRUN9xt/W94g=
  - secure: bAS2ZfTRxzR7AtsIXy0i8WSNa+fwh4aTS0+8iyKmOpKygw+kkRZj20uexDgSQFdGQzQwYXTjgNvldD1ad4KHHcqoxuh7N2fI/SS/8xGOu2Xb5xvn2Pt5EFXKQ9QnYa6flHMEfeddoM41kiRHR/e59R9/gAr6cfKMye/b20JlmmppV+T2zvFgU+w1GhOmRPGkTE0xdBpdgZGjVP+ux9ydrta23dB8qLjAr6fMDCYGA0XXGOjGib5qBBVsDgkBThWuqM7lUBFemk0bzBjQxz3PrKT88ZdMVi+9WdlGJ7Qy6Niip6r21tNsAUMyeF3uvDw+6rb5BGntYDR05wB2hdBdzjmVu6A8SiFuUDSsRBdu+2VKpDesnR4/f+6THyivXSm7YP92VM0NSwJyYvN8HUWZTRW/+ely35rrtcm+cisbSJch1sNYrp/jT5l2LKVwlb7xno5JXjf7AxTV9JhPEtikEkDlMdotYOWHOqGAvNp4Aw3+oH0sv69otfoK/68z4F+HqN4CDn8ou8Hm55rwQsEsLXX6jgy2PbgOpPil15lTY/OgoiSDbeiNmVByhiWMYX8zidlRedN39lwEZhycPS7wnhQmBU8Bstf821FAsZQlldPM3Btg72kydMTTtUpmtW1hy9B5QkUym5yR9Qy4qlzkJTfLmTmrEkLuBm9/BbVJgGs=
before_install:
- mkdir -p ~/.aws
- cat > ~/.aws/credentials << EOL
- - default
- aws_access_key_id = ${AWS_ACCESS_KEY_ID}
- aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
- sudo bash -c "echo 'Acquire::ForceIPv4 \"true\";' > /etc/apt/apt.conf.d/99force-ipv4"
- travis_retry sudo apt-get -y -qq update
- travis_retry sudo apt-get install -y -qq software-properties-common python-software-properties
- travis_retry sudo apt-add-repository -y ppa:octave/stable
- travis_retry sudo apt-get -y -qq update
- travis_retry sudo apt-get install -y wget
- travis_retry sudo apt-get -y -qq install octave liboctave-dev octave-pkg-dev
- travis_retry wget http://sourceforge.net/projects/octave/files/Octave%20Forge%20Packages/Individual%20Package%20Releases/struct-1.0.14.tar.gz
  -P /home/travis/octave
- travis_retry wget http://sourceforge.net/projects/octave/files/Octave%20Forge%20Packages/Individual%20Package%20Releases/optim-1.5.2.tar.gz
  -P /home/travis/octave
- travis_retry wget https://sourceforge.net/projects/octave/files/Octave%20Forge%20Packages/Individual%20Package%20Releases/io-2.4.10.tar.gz
  -P /home/travis/octave
- travis_retry wget http://sourceforge.net/projects/octave/files/Octave%20Forge%20Packages/Individual%20Package%20Releases/statistics-1.3.0.tar.gz
  -P /home/travis/octave
- travis_retry wget http://sourceforge.net/projects/octave/files/Octave%20Forge%20Packages/Individual%20Package%20Releases/image-2.6.1.tar.gz
  -P /home/travis/octave
- make -C External/MOcov install
- pip install --user awscli
- mkdir -p ~/$TRAVIS_BUILD_NUMBER
- aws s3 sync s3://qmrlab/$TRAVIS_BUILD_NUMBER ~/$TRAVIS_BUILD_NUMBER
jobs:
  include:
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible/quickMoxTests');res=moxunit_runtests('-recursive','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_quickMoxTests.json');exit(~res);";
      mv coverage_quickMoxTests.json ~/$TRAVIS_BUILD_NUMBER/coverage_quickMoxTests.json
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('BatchExample_test.m','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_BatchExample.json');exit(~res);";
      mv coverage_BatchExample.json ~/$TRAVIS_BUILD_NUMBER/coverage_BatchExample.json
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_charmed.m','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_SimTest_charmed.json');exit(~res);"
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_dti.m','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_SimTest_dti.json');exit(~res);"
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_noddi.m','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_SimTest_noddi.json');exit(~res);"
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_qmt_bssfp.m');exit(~res);"
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_qmt_sirfse.m','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_SimTest_qmt_sirfse.json');exit(~res);"
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_qmt_spgr.m');exit(~res);"
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_inversion_recovery.m','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_SimTest_inversion_recovery.json');exit(~res);"
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_vfa_t1.m','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_SimTest_vfa_t1.json');exit(~res);"
  - stage: Test
    script: travis_wait 30 octave --no-gui --eval "bootstrapTest;cd('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible');res=moxunit_runtests('SimTest_mwf.m','-with_coverage','-cover','/home/travis/build/neuropoly/qMRLab/src','-cover_json_file','coverage_SimTest_mwf.json');exit(~res);"
  - stage: CombineReports
    script: mv ~/$TRAVIS_BUILD_NUMBER/*.json /home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible/;octave --no-gui --eval "cd('/home/travis/build/neuropoly/qMRLab/');startup;mocov_combine('/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible/','coverage_combined.json')"; mv /home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible/coverage_combined.json ~/$TRAVIS_BUILD_NUMBER/coverage_combined.json
  - stage: Coveralls
    script: mv ~/$TRAVIS_BUILD_NUMBER/coverage_combined.json /home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible/coverage_combined.json;curl --verbose -F json_file=@/home/travis/build/neuropoly/qMRLab/Test/MoxUnitCompatible/coverage_combined.json https://coveralls.io/api/v1/jobs
